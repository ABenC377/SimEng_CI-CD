

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Kernel &mdash; SimEng  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Simulation Components" href="../components/index.html" />
    <link rel="prev" title="System Calls" href="syscalls.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SimEng
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developerInfo.html">Developer information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Simulation Concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="instructions.html">Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="registers.html">Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="syscalls.html">System Calls</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linuxprocess">LinuxProcess</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#elf-parsing">ELF Parsing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#linux">Linux</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">Simulation Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/index.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch/index.html">Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../test/index.html">Testing</a></li>
</ul>
<p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/building_simeng.html">Building SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/running_simeng.html">Running SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/configuring_simeng.html">Configuring SimEng</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/creating_binaries.html">Creating Binaries</a></li>
</ul>
<p class="caption"><span class="caption-text">SST Integration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sst/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sst/building_simeng_with_sst.html">Building SimEng with SST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sst/understanding_sst.html">Understanding SST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sst/running_simeng_with_sst.html">Running SimEng with SST</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SimEng</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Simulation Concepts</a> &raquo;</li>
        
      <li>Kernel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/developer/concepts/kernel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kernel">
<h1>Kernel<a class="headerlink" href="#kernel" title="Permalink to this headline">¶</a></h1>
<p>The Kernel used in SimEng is an emulation of a Linux Kernel. The SimEng Kernel does not seek to provide the full functionality of a Linux Kernel. Instead, it provides the functionality for creating the program memory space and aid the emulation of system calls by maintaining a system and process state.</p>
<p>The SimEng Kernel is split into two classes, <code class="docutils literal"><span class="pre">LinuxProcess</span></code> and <code class="docutils literal"><span class="pre">Linux</span></code>.</p>
<div class="section" id="linuxprocess">
<h2>LinuxProcess<a class="headerlink" href="#linuxprocess" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">LinuxProcess</span></code> class provides the functionality to process the supplied program. It creates the initial process memory space, including the Executable and Linkable Format (ELF) process image and the stack. The process memory space created contains all the data required by the program to run.</p>
<div class="section" id="elf-parsing">
<h3>ELF Parsing<a class="headerlink" href="#elf-parsing" title="Permalink to this headline">¶</a></h3>
<p>The ELF binaries have a defined structure for 32-bit and 64-bit architectures, all information regarding parsing ELF binaries has been referenced from the <a class="reference external" href="https://man7.org/linux/man-pages/man5/elf.5.html">Linux manual page</a>. The ELF binary is divided into multiple parts. SimEng stores all relevant parts of the <cite>ELF Binary</cite> in a <code class="docutils literal"><span class="pre">char[]</span> <span class="pre">processImage</span></code> array, which is a private member variable of the <code class="docutils literal"><span class="pre">LinuxProcess</span></code> class.</p>
<img alt="ELF Structure" class="align-center" src="../../_images/elfstruct.png" />
<ul>
<li><p class="first">The <cite>ELF Header</cite> is the first part of <cite>ELF binary</cite>. The <cite>ELF Header</cite> holds information regarding the structure of the <cite>ELF Binary</cite>. SimEng extracts the following from the <cite>ELF Header</cite>:</p>
<blockquote>
<div><ul class="simple">
<li>The entry point of binary i.e. the virtual address to which the system first transfers control.</li>
<li>The file offset of the <cite>ELF Program Headers</cite>.</li>
<li>The size of each entry stored in the <cite>ELF Program Header</cite>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">The <cite>ELF Program Header</cite> table is an array of structures, each describing a segment or other information the system needs to prepare the program for execution. An object file segment contains one or more sections, each section holds program and control information. SimEng extracts the following from the <cite>ELF Program Headers</cite>:</p>
<blockquote>
<div><ul class="simple">
<li>The offset from the beginning of the file at which the first byte of the segment resides.</li>
<li>The number of bytes in the memory image of the segment.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">SimEng uses these extracted values to loop through all <cite>ELF Program Headers</cite> and looks for the <cite>ELF Program Header</cite> located at largest virtual address range. SimEng uses the largest virtual address and size associated with that <cite>ELF Program Header</cite> to create an array called the <code class="docutils literal"><span class="pre">ElfProcessImage</span></code>. Internally, SimEng treats these virtual address as physical addresses to index into said array.</p>
</li>
<li><p class="first">The segment referenced by an ELF Program Header has a type attribute which explains its contents and how to interpret it. SimEng, only extracts segments of type <code class="docutils literal"><span class="pre">LOAD</span></code> which specifies a loadable segment. Loadable segments most notably contain the workloads’ compiled instructions and initialised data that contributes to the program’s memory space. This completes the creation of the <code class="docutils literal"><span class="pre">ElfProcessImage</span></code>.</p>
</li>
<li><p class="first">After the <code class="docutils literal"><span class="pre">ElfProcessImage</span></code> has been created the <code class="docutils literal"><span class="pre">LinuxProcess</span></code> class creates an array <code class="docutils literal"><span class="pre">char[]</span> <span class="pre">processImage</span></code>. The size of <code class="docutils literal"><span class="pre">processImage</span></code> is much larger than <code class="docutils literal"><span class="pre">ElfProcessImage</span></code> as SimEng adds the <code class="docutils literal"><span class="pre">HEAP_SIZE</span></code> and <code class="docutils literal"><span class="pre">STACK_SIZE</span></code> values specified in the YAML configuration file to the 32-byte aligned value of <code class="docutils literal"><span class="pre">ElfProcessImage</span></code> size. After this, SimEng proceeds to create a process stack around <code class="docutils literal"><span class="pre">processImage</span></code>.</p>
</li>
<li><p class="first">The population of the initial stack state is based on the information <a class="reference external" href="https://www.win.tue.nl/~aeb/linux/hh/stack-layout.html">here</a>.</p>
</li>
</ul>
<p>Currently, the only environment variable set is <code class="docutils literal"><span class="pre">OMP_NUM_THREADS=1</span></code>, however, functionality to add more is available.</p>
<p>For the supplied program, the <code class="docutils literal"><span class="pre">LinuxProcess</span></code> class supports both statically compiled binaries and raw instructions in a hexadecimal format.</p>
</div>
</div>
<div class="section" id="linux">
<h2>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">Linux</span></code> class provides part of the functionality used to emulate system calls by maintaining a system and process state. These states contain information about the <code class="docutils literal"><span class="pre">LinuxProcess</span></code> class created from the supplied program. Such information includes:</p>
<ul class="simple">
<li>PID</li>
<li>Program path</li>
<li>Start location for brk system calls</li>
<li>Current location of the most recent brk system call</li>
<li>The initial stack pointer</li>
<li><code class="docutils literal"><span class="pre">fileDescriptorTable</span></code> that tracks the open file descriptors</li>
</ul>
<p>All system call functionality is invoked within the <code class="docutils literal"><span class="pre">Linux</span></code> class, and any return value associated with the system call is generated here.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../components/index.html" class="btn btn-neutral float-right" title="Simulation Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="syscalls.html" class="btn btn-neutral float-left" title="System Calls" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, SimEng developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
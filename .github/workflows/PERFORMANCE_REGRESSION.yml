name: PERFORMANCE_REGRESSION

env:
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  LLVM-VERSION: 14
  BENCHMARK_BRANCH: 'make-file-build-system' # The branch inside the benchmark repo that has the script to run all benchmarks.
  PAT: ${{ secrets.SIMENGUOB_PAT }}

on:
  workflow_dispatch:
  pull_request:
  push:

jobs:
  Build_and_Run:
    runs-on: ubuntu-latest
    
    container:
      image: ubuntu:20.04

    steps:
      #######################################
      # Clone SimEng fork
      #######################################
      - name: checkout v4
        uses: actions/checkout@v4
      
      #######################################
      # install compiler and build SimEng
      #######################################
      - name: setup compiler and OS env + build simeng
        uses: ./.github/actions/select_env
        with: 
          LLVM-VERSION: ${{ env.LLVM-VERSION }}
          OS: ubuntu:20.04
          COMPILER: gcc-10

      #######################################
      # Prints out info in isolated step for easy access.
      #######################################
      - name: INFO
        shell: bash
        run: |
          cat /etc/os-release 
          echo "_______________________________________"
          cmake --version
          echo "_______________________________________"
          "${{ env.GCC_DIR }}" --version
          which gcc
          echo "_______________________________________"
          "${{ env.CPP_DIR }}" --version
          which g++
          echo "_______________________________________"

      #######################################
      # Checkout simeng-benchmark repository
      #######################################
      - name: checking out benchmark repository
        uses: actions/checkout@v4
        with:
          repository: UoB-HPC/simeng-benchmarks
          ref: makefile-build-system
          token: ${{ env.PAT }}
          path: simeng-benchmarks

      #######################################
      # Cloverleaf
      #######################################
      # check for previous time in cache
      - name: check for previous cloverleaf time in cache
        uses: actions/cache/restore@v4
        id: cloverleaf_restore
        with:
          path: ./cloverleaf_benchmark_out.txt
          key: cloverleaf_benchmark_out
      
      # run benchmark and output difference if there is any
      - name: run cloverleaf_gcc10.3.0_armv8.4+sve & compare runtimes
        shell: bash
        run: |
          if [[ ${{ steps.cloverleaf_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            echo hello
            previous_time=$(grep 'ticks in' cloverleaf_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          else
            previous_time="No Previous Time"
          fi

          simeng ./configs/a64fx.yaml ./simeng-benchmarks/binaries/CloverLeaf/openmp/cloverleaf_gcc10.3.0_armv8.4+sve > cloverleaf_benchmark_out.txt
          
          current_time=$(grep 'ticks in' cloverleaf_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          
          echo "#############################################"
          echo "CLOVERLEAF (cloverleaf_gcc10.3.0_armv8.4+sve)"
          echo "Current Time: ${current_time}ms"

          if [[ ${{ steps.cloverleaf_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            difference=$((current_time-previous_time))
            echo "Previous Time: ${previous_time}ms"
            echo "Absolute Difference: ${difference#-}ms"
          else
            echo $(previous_time)
          fi
      
      # always overwrite previous time
      - name: store benchmark output into cache
        uses: actions/cache/save@v4
        id: cloverleaf_save
        with:
          path: ./cloverleaf_benchmark_out.txt
          key: cloverleaf_benchmark_out

      #######################################
      # miniBUDE
      #######################################
      # check for previous time in cache
      - name: check for previous minibude time in cache
        uses: actions/cache/restore@v4
        id: miniBUDE_restore
        with:
          path: ./miniBUDE_benchmark_out.txt
          key: miniBUDE_benchmark_out
      
      # run benchmark and output difference if there is any
      - name: run minibude_gcc10.3.0_armv8.4+sve & compare runtimes
        shell: bash
        run: |
          if [[ ${{ steps.miniBUDE_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            previous_time=$(grep 'ticks in' miniBUDE_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          else
            previous_time="No Previous Time"
          fi

          simeng ./configs/a64fx.yaml ./simeng-benchmarks/binaries/miniBUDE/openmp/minibude_gcc10.3.0_armv8.4+sve > miniBUDE_benchmark_out.txt
          
          current_time=$(grep 'ticks in' miniBUDE_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          
          echo "#############################################"
          echo "MINIBUDE (minibude_gcc10.3.0_armv8.4+sve)"
          echo "Current Time: ${current_time}ms"

          if [[ ${{ steps.miniBUDE_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            difference=$((current_time-previous_time))
            echo "Previous Time: ${previous_time}ms"
            echo "Absolute Difference: ${difference#-}ms"
          else
            echo $(previous_time)
          fi
      
      # always overwrite previous time
      - name: store benchmark output into cache
        uses: actions/cache/save@v4
        id: miniBUDE_save
        with:
          path: ./miniBUDE_benchmark_out.txt
          key: miniBUDE_benchmark_out

      #######################################
      # STREAM
      #######################################
      # check for previous time in cache
      - name: check for previous stream time in cache
        uses: actions/cache/restore@v4
        id: stream_restore
        with:
          path: ./stream_benchmark_out.txt
          key: stream_benchmark_out
      
      # run benchmark and output difference if there is any
      - name: run stream_gcc10.3.0_armv8.4+sve & compare runtimes
        shell: bash
        run: |
          if [[ ${{ steps.stream_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            previous_time=$(grep 'ticks in' stream_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          else
            previous_time="No Previous Time"
          fi

          simeng ./configs/a64fx.yaml ./simeng-benchmarks/binaries/STREAM/stream_gcc10.3.0_armv8.4+sve > stream_benchmark_out.txt
          
          current_time=$(grep 'ticks in' stream_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          
          echo "#############################################"
          echo "STREAM (stream_gcc10.3.0_armv8.4+sve)"
          echo "Current Time: ${current_time}ms"

          if [[ ${{ steps.stream_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            difference=$((current_time-previous_time))
            echo "Previous Time: ${previous_time}ms"
            echo "Absolute Difference: ${difference#-}ms"
          else
            echo $(previous_time)
          fi
      
      # always overwrite previous time
      - name: store benchmark output into cache
        uses: actions/cache/save@v4
        id: stream_save
        with:
          path: ./stream_benchmark_out.txt
          key: stream_benchmark_out

      #######################################
      # TeaLeaf
      #######################################
      # check for previous time in cache
      - name: check for previous stream time in cache
        uses: actions/cache/restore@v4
        id: tealeaf_restore
        with:
          path: ./tealeaf_benchmark_out.txt
          key: tealeaf_benchmark_out
      
      # run benchmark and output difference if there is any
      - name: run tealeaf_gcc10.3.0_armv8.4+sve & compare runtimes
        shell: bash
        run: |
          if [[ ${{ steps.tealeaf_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            previous_time=$(grep 'ticks in' tealeaf_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          else
            previous_time="No Previous Time"
          fi

          simeng ./configs/a64fx.yaml ./simeng-benchmarks/binaries/TeaLeaf/3d/tealeaf_gcc10.3.0_armv8.4+sve > tealeaf_benchmark_out.txt
          
          current_time=$(grep 'ticks in' tealeaf_benchmark_out.txt | awk '{print substr($6, 1, length($6)-2)}')
          
          echo "#############################################"
          echo "TeaLeaf (tealeaf_gcc10.3.0_armv8.4+sve)"
          echo "Current Time: ${current_time}ms"

          if [[ ${{ steps.tealeaf_restore.outputs.cache-hit == 'true' }} == 'true' ]]; then
            difference=$((current_time-previous_time))
            echo "Previous Time: ${previous_time}ms"
            echo "Absolute Difference: ${difference#-}ms"
          else
            echo $(previous_time)
          fi
      
      # always overwrite previous time
      - name: store benchmark output into cache
        uses: actions/cache/save@v4
        id: tealeaf_save
        with:
          path: ./tealeaf_benchmark_out.txt
          key: tealeaf_benchmark_out
name: MACOS_CLANG_BUILD_TEST

env:
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  LLVM-VERSION: 14
  BENCHMARK_BRANCH: 'make-file-build-system' # The branch inside the benchmark repo that has the script to run all benchmarks.
  PAT: ${{ secrets.SIMENGUOB_PAT }}
  
on:
  push:

jobs:
  Build_and_Run:
    runs-on: macos-13

    name: "macos-13 + apple_clang"

    steps:
      #######################################
      # Clones repo to workspace.
      #######################################
      - name: checkout v4
        uses: actions/checkout@v4

      #######################################
      # Depending on OS and compiler, this step chooses the correct setup action to run.
      #######################################
      - name: setup compiler and OS env + build simeng
        uses: ./.github/actions/select_setup
        with: 
          OS: 'macos'
          COMPILER: 'apple_clang'
          LLVM-VERSION: ${{ env.LLVM-VERSION }}

      #######################################
      # Prints out info in isolated step for easy access.
      #######################################
      - name: INFO
        shell: bash
        run: |
          echo "_______________________________________"
          cmake --version
          echo "_______________________________________"
          "${{ env.APPLE_CLANG_DIR }}" --version
          which clang
          echo "_______________________________________"
          "${{ env.APPLE_CLANG_PLUS_PLUS_DIR }}" --version
          which g++
          echo "_______________________________________"
          
      #######################################
      # Run Integration Tests.
      #######################################
      - name: Integration Tests
        shell: bash
        run: |
          ./build/test/integration/integrationtests

      #######################################
      # Run Unit Tests.
      #######################################
      - name: Unit Tests
        shell: bash
        run: |
          ./build/test/unit/unittests

      #######################################
      # Run Regression AARCH64 Tests.
      #######################################
      - name: regression test (aarch64)
        if: always()
        shell: bash
        run: |
          ./build/test/regression/aarch64/regression-aarch64

      #######################################
      # Run Regression RISCV Tests.
      #######################################
      - name: regression test (riscv)
        if: always()
        shell: bash
        run: |
          ./build/test/regression/riscv/regression-riscv

      #######################################
      # Run Benchmark Tests.
      #######################################
      - if: always()
        name: run benchmarks
        uses: ./.github/actions/simeng_benchmarks
        with:
          BENCHMARK_BRANCH: ${{ env.BENCHMARK_BRANCH }}
          OS: macos
          PAT: ${{ env.PAT }}
      ##########################################